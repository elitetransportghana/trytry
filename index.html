<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Transport — Christmas Break Bus Booking</title>
<script src="https://js.paystack.co/v1/inline.js"></script>
<style>
body { font-family: Arial; background:#f6f7fb; margin:0; padding:20px;}
.container { max-width:900px; margin:auto; background:white; padding:20px; border-radius:12px;}
input, select, button { padding:8px; margin-bottom:12px; border-radius:6px; border:1px solid #ccc; width:100%;}
button { background:#0ea5a4; color:white; border:none; cursor:pointer;}
.seatmap { display:grid; grid-template-columns:repeat(7,50px); gap:8px; margin-bottom:12px;}
.seat { width:50px; height:50px; background:#eef2ff; display:flex; align-items:center; justify-content:center; border-radius:6px; cursor:pointer;}
.seat.selected { background:#06b6d4; color:white;}
.seat.taken { background:#111827; color:white; cursor:not-allowed; opacity:0.7;}
.aisle { width:20px;}
.summary { background:#fbfdff; padding:12px; border-radius:8px; border:1px solid #eef2ff; margin-top:12px;}
</style>
</head>
<body>
<div class="container">
  <h1>Elite Transport — Christmas Break Bus Booking</h1>

  <input type="text" id="fullname" placeholder="Full Name">
  <input type="text" id="phone" placeholder="Phone Number">

  <label>Travel Date</label>
  <select id="date">
    <option value="2025-12-20">20th Dec</option>
    <option value="2025-12-21">21st Dec</option>
  </select>

  <label>Route</label>
  <select id="route">
    <option value="Accra">Accra — ₵240</option>
    <option value="Kumasi">Kumasi — ₵140</option>
    <option value="Sunyani">Sunyani — ₵140</option>
    <option value="Takoradi">Takoradi — ₵240</option>
  </select>

  <h2>Select Seats (1–49)</h2>
  <div id="seatmap" class="seatmap"></div>

  <div class="summary">
    <p>Seats Selected: <span id="selectedCount">0</span></p>
    <p>Total: ₵<span id="total">0</span></p>
  </div>

  <button id="book">Pay & Book Now</button>
</div>

<script>
// ===== Config =====
const ROUTE_PRICES = { "Accra": 245, "Kumasi": 143, "Sunyani": 143, "Takoradi": 245 };
const WORKER_URL = "https://odd-silence-7d6e.elitetransportghana.workers.dev";
const seats = {};
const selected = new Set();
const seatmapEl = document.getElementById("seatmap");
const selectedCountEl = document.getElementById("selectedCount");
const totalEl = document.getElementById("total");

// ===== Build Seats =====
function buildSeats(){
  seatmapEl.innerHTML = "";
  for(let i=1;i<=49;i++){
    seats[i] = seats[i] || {status:"free"};
    const div = document.createElement("div");
    div.className="seat";
    div.dataset.id=i;
    div.textContent=i;
    div.addEventListener("click",()=> selectSeat(i));
    seatmapEl.appendChild(div);
    if(i%7===0 && i<49){
      const aisle = document.createElement('div');
      aisle.className='aisle';
      seatmapEl.appendChild(aisle);
    }
  }
}

function selectSeat(i){
  if(seats[i].status==="taken") return;
  if(selected.has(i)) selected.delete(i);
  else selected.add(i);
  refreshSeatsUI();
  updateSummary();
}

function refreshSeatsUI(){
  document.querySelectorAll(".seat").forEach(el=>{
    const id = parseInt(el.dataset.id);
    el.classList.remove("selected","taken");
    if(selected.has(id)) el.classList.add("selected");
    if(seats[id].status==="taken") el.classList.add("taken");
  });
}

function updateSummary(){
  const route = document.getElementById("route").value;
  const price = ROUTE_PRICES[route];
  selectedCountEl.textContent = selected.size;
  totalEl.textContent = (selected.size * price).toFixed(2);
}

// ===== Pay & Book =====
document.getElementById("book").addEventListener("click", ()=>{
  const name = document.getElementById("fullname").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const date = document.getElementById("date").value;
  const route = document.getElementById("route").value;

  if(!name || !phone){ alert("Enter name and phone"); return; }
  if(selected.size===0){ alert("Select at least one seat"); return; }

  const seatsArr = Array.from(selected);
  const amount = seatsArr.length * ROUTE_PRICES[route] * 100;

  const handler = PaystackPop.setup({
    key: "pk_test_d1cfdee00c5d5743830737d892e4e86705a4d9cd",
    email: phone+"@example.com",
    amount,
    currency:"GHS",
    ref: 'ET'+Math.floor(Math.random()*1000000000+1),
    metadata:{ name, phone, route, date, seats: seatsArr },
    callback: async function(response){
      alert("Payment successful! Ref: " + response.reference);

      // Send booking to Cloudflare Worker
      try {
        const res = await fetch(WORKER_URL+"/book", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            reference: response.reference,
            name, phone, route, date,
            seats: seatsArr
          })
        });
        const data = await res.json();
        console.log("Booking saved:", data);

        // Mark seats as taken locally
        seatsArr.forEach(id=>seats[id].status="taken");
        selected.clear();
        refreshSeatsUI();
        updateSummary();

      } catch(err){
        console.error("Failed to save booking:", err);
        alert("Payment successful, but booking could not be saved. Please contact support.");
      }
    },
    onClose: function(){ alert("Payment cancelled"); }
  });

  handler.openIframe();
});

// ===== Init =====
buildSeats();
refreshSeatsUI();
updateSummary();
</script>
</body>
</html>
